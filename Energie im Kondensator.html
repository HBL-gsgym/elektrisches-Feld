<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Interaktives Arbeitsblatt – Energie im Kondensator</title>

  <!-- MathJax (v3) -->
  <script>
    window.MathJax = {
      tex: { inlineMath: [['\\(', '\\)'], ['$', '$']] },
      options: { skipHtmlTags: ['script','noscript','style','textarea','pre','code','select','option'] }
    };
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --ink:#1f2430;
      --muted:#5d677a;
      --line:#e5e8f0;
      --ok:#157f3b;
      --bad:#b42318;
      --warn:#8a6d00;
      --shadow: 0 8px 24px rgba(31,36,48,.08);
      --radius: 14px;
      --pad: 14px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }

    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); color:var(--ink);
      background: radial-gradient(1200px 600px at 20% -10%, #eef2ff 0%, transparent 60%),
                  radial-gradient(900px 500px at 110% 10%, #ecfeff 0%, transparent 55%),
                  var(--bg);
    }
    .wrap{max-width:980px;margin:0 auto;padding:18px 14px 28px}

    /* Header */
    .topbar{
      display:grid; grid-template-columns: 1fr auto 1fr;
      align-items:center; gap:10px;
      padding:10px 14px; background:rgba(255,255,255,.75);
      border:1px solid var(--line); border-radius:var(--radius);
      box-shadow: var(--shadow); backdrop-filter: blur(6px);
    }
    .topbar .left{font-weight:700; letter-spacing:.3px}
    .topbar .mid{justify-self:center; font-weight:700}
    .topbar .right{justify-self:end; color:var(--muted); font-size:13px}

    .metaRow{
      display:grid; grid-template-columns: 1.3fr 1fr;
      gap:12px; margin-top:12px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:var(--pad);
    }
    .metaBox h2{margin:0 0 6px 0; font-size:18px}
    .metaBox .kv{display:grid; grid-template-columns: 140px 1fr; row-gap:6px; column-gap:10px; margin-top:10px}
    .metaBox .k{color:var(--muted); font-size:13px}
    .metaBox .v{font-weight:650}
    .hint{margin-top:10px; color:var(--muted); font-size:13px; line-height:1.35}

    .nameBox label{display:block; font-weight:650; margin-bottom:6px}
    input[type="text"]{
      width:100%; padding:10px 11px; border-radius:12px;
      border:1px solid var(--line); outline:none; font-size:15px;
      background:#fff;
    }
    input[type="text"]:focus{border-color:#b8c2ff; box-shadow:0 0 0 3px rgba(99,102,241,.15)}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px}
    .btn{
      border:1px solid var(--line);
      background:#fff; color:var(--ink);
      padding:10px 12px; border-radius:12px;
      font-weight:650; cursor:pointer;
    }
    .btn:hover{background:#f8fafc}
    .btnPrimary{
      background:#111827; color:#fff; border-color:#111827;
    }
    .btnPrimary:hover{background:#0b1220}
    .btnWarn{
      background:#fff7ed; border-color:#fed7aa;
    }
    .btnWarn:hover{background:#ffedd5}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--line); background:#fff;
      font-size:13px; color:var(--muted);
    }
    .statusOk{color:var(--ok); font-weight:700}
    .statusBad{color:var(--bad); font-weight:700}
    .statusWait{color:var(--muted); font-weight:700}

    /* Tasks */
    .tasks{margin-top:14px; display:flex; flex-direction:column; gap:12px}
    .task{
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .taskHead{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      padding:12px 14px;
      border-bottom:1px solid rgba(0,0,0,.06);
    }
    .taskTitle{margin:0; font-size:16px}
    .taskMeta{color:var(--muted); font-size:13px; margin-top:3px}
    .taskBody{padding:14px}
    .qtext{line-height:1.45; margin:0 0 10px 0}
    .options{display:flex; flex-direction:column; gap:8px; margin-top:8px}
    .opt{
      display:flex; gap:10px; align-items:flex-start;
      padding:8px 10px; border:1px solid var(--line);
      border-radius:12px; background:rgba(255,255,255,.7);
    }
    .opt input{margin-top:2px}
    .opt label{cursor:pointer; flex:1}
    .subgrid{display:grid; grid-template-columns: 1.3fr 1fr; gap:10px}
    .subrow{
      display:grid; grid-template-columns: 1.3fr 1fr;
      gap:10px; align-items:center;
      padding:8px 10px; border:1px solid var(--line);
      border-radius:12px; background:rgba(255,255,255,.7);
      margin-top:8px;
    }
    select{
      width:100%; padding:9px 10px; border-radius:12px;
      border:1px solid var(--line); background:#fff; font-size:14px;
    }
    .feedback{
      margin-top:10px; padding:10px 12px; border-radius:12px;
      border:1px solid var(--line); background:#fff;
      line-height:1.35;
    }
    .fbOk{border-color: rgba(21,127,59,.35); background:rgba(21,127,59,.06)}
    .fbBad{border-color: rgba(180,35,24,.35); background:rgba(180,35,24,.06)}
    .fbWarn{border-color: rgba(138,109,0,.35); background:rgba(138,109,0,.06)}
    .fbSmall{color:var(--muted); font-size:13px; margin-top:6px}

    .sol{
      margin-top:10px; border-top:1px dashed rgba(0,0,0,.12);
      padding-top:10px;
      display:none;
    }
    .sol h4{margin:0 0 6px 0; font-size:14px}
    .sol .solBody{color:#111827; line-height:1.45}

    /* Pastel backgrounds per task */
    .bg1{background:linear-gradient(0deg, rgba(255,255,255,.88), rgba(255,255,255,.88)), #fef3c7}
    .bg2{background:linear-gradient(0deg, rgba(255,255,255,.88), rgba(255,255,255,.88)), #e0f2fe}
    .bg3{background:linear-gradient(0deg, rgba(255,255,255,.88), rgba(255,255,255,.88)), #ede9fe}
    .bg4{background:linear-gradient(0deg, rgba(255,255,255,.88), rgba(255,255,255,.88)), #dcfce7}
    .bg5{background:linear-gradient(0deg, rgba(255,255,255,.88), rgba(255,255,255,.88)), #ffe4e6}
    .bg6{background:linear-gradient(0deg, rgba(255,255,255,.88), rgba(255,255,255,.88)), #f1f5f9}
    .bg7{background:linear-gradient(0deg, rgba(255,255,255,.88), rgba(255,255,255,.88)), #ecfccb}
    .bg8{background:linear-gradient(0deg, rgba(255,255,255,.88), rgba(255,255,255,.88)), #fae8ff}
    .bg9{background:linear-gradient(0deg, rgba(255,255,255,.88), rgba(255,255,255,.88)), #cffafe}
    .bg10{background:linear-gradient(0deg, rgba(255,255,255,.88), rgba(255,255,255,.88)), #ffedd5}
    .bg11{background:linear-gradient(0deg, rgba(255,255,255,.88), rgba(255,255,255,.88)), #e5e7eb}
    .bg12{background:linear-gradient(0deg, rgba(255,255,255,.88), rgba(255,255,255,.88)), #e9d5ff}

    /* Print */
    @media print{
      body{background:#fff}
      .wrap{max-width:none; padding:0}
      .card, .task{box-shadow:none}
      .btn, .row, .pill, .feedback .fbSmall, .solBtn, .checkBtn, .sendBtn, .localNote {display:none !important}
      input, select{border:0 !important}
      .topbar{border:0; box-shadow:none; background:#fff}
      .task{page-break-inside: avoid}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="left">HBL</div>
      <div class="mid">Physik GK 11</div>
      <div class="right" id="today"></div>
    </div>

    <div class="metaRow">
      <div class="card metaBox">
        <h2>Arbeitsblatt-Info</h2>
        <div class="kv">
          <div class="k">Kursname</div><div class="v" id="courseUi"></div>
          <div class="k">Arbeitsblatt-ID</div><div class="v" id="sheetUi"></div>
          <div class="k">Wertung</div><div class="v">Nur der <b>erste</b> Klick auf „Prüfen“ pro Aufgabe zählt.</div>
        </div>
        <div class="hint">
          Hinweise: Du kannst Antworten jederzeit ändern – das Feedback ändert sich, aber die Wertung bleibt beim Erstversuch.
          Nach <b>3 Fehlversuchen</b> wird der Button „Lösungsweg anzeigen“ freigeschaltet.
        </div>
      </div>

      <div class="card nameBox">
        <label for="studentName">Name (Pflicht)</label>
        <input id="studentName" type="text" placeholder="Vorname Nachname" autocomplete="name" />
        <div class="row">
          <button class="btn btnPrimary sendBtn" id="sendBtn">Ergebnisse an HBL senden</button>
          <span class="pill">Status: <span id="sendStatus" class="statusWait">—</span></span>
          <span class="pill">Score: <span id="scoreUi">0/12</span></span>
        </div>
        <div class="hint localNote">
          Lokale Speicherung ist aktiv (Name, Antworten, Erstversuch-Wertung, Fehlversuche, Lösungswege).
        </div>
      </div>
    </div>

    <div class="tasks" id="tasks"></div>
  </div>

<script>
/* =========================
   FESTE METADATEN (Code)
========================= */
const COURSE_NAME = "GK Ph 11 2025";
const SHEET_ID    = "Energie im Kondensator";
const WEBAPP_URL  = "https://script.google.com/macros/s/AKfycbwNSC_7Jbv7j-NZpVHpWH41R-E97eVqg6BYLHI5N-Cn9cb7iGWHmiXiJk3RciO2gbM8XQ/exec";

/* =========================
   STORAGE / STATE
========================= */
const STORE_KEY = "HBL_AB_STATE__" + COURSE_NAME + "__" + SHEET_ID;

function nowIso(){ return new Date().toISOString(); }
function clampInt(n, a, b){ n = (n|0); return Math.max(a, Math.min(b, n)); }

function loadState(){
  const raw = localStorage.getItem(STORE_KEY);
  if(raw){
    try { return JSON.parse(raw); } catch(e){}
  }
  // default state
  return {
    startedAt: nowIso(),
    seed: Math.floor(Math.random()*1e9),
    name: "",
    answers: {},           // per taskId
    attempted: {},         // per taskId boolean
    firstCorrect: {},      // per taskId boolean
    wrongStreak: {},       // per taskId number
    solutionUnlocked: {},  // per taskId boolean
    send: { lastStatus:"—", lastAt:null }
  };
}
function saveState(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }

let state = loadState();

/* =========================
   SEEDED RNG + SHUFFLE
========================= */
function mulberry32(a){
  return function(){
    let t = a += 0x6D2B79F5;
    t = Math.imul(t ^ t >>> 15, t | 1);
    t ^= t + Math.imul(t ^ t >>> 7, t | 61);
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  };
}
function seededShuffle(arr, seed){
  const rng = mulberry32(seed >>> 0);
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(rng()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

/* =========================
   TASKS (12)
   - Jede Auswahl hat 5 Optionen
========================= */
const tasksData = [
  {
    id:"T1",
    type:"radio",
    title:"Kapazität – Einflussgrößen",
    meta:"Einfachauswahl (1 richtig)",
    prompt:"Welche Maßnahme vergrößert die Kapazität eines Plattenkondensators?",
    options:[
      {k:"A", t:"Vergrößerung des Plattenabstands", ok:false},
      {k:"B", t:"Verkleinerung der Plattenfläche", ok:false},
      {k:"C", t:"Einbringen eines Dielektrikums zwischen die Platten", ok:true},
      {k:"D", t:"Erhöhung der angelegten Spannung", ok:false},
      {k:"E", t:"Entfernen einer Isolierschicht zwischen den Platten", ok:false}
    ],
    solutionHtml: `
      <p>Für den Plattenkondensator gilt \\(C=\\varepsilon_0\\,\\varepsilon_r\\,\\frac{A}{d}\\).</p>
      <ul>
        <li>Ein Dielektrikum erhöht \\(\\varepsilon_r\\) ⇒ \\(C\\) wird größer.</li>
        <li>Spannung \\(U\\) steht nicht in der Kapazitätsformel (für gegebene Geometrie und Material).</li>
      </ul>`
  },

  {
    id:"T2",
    type:"checkbox",
    title:"Dielektrikum – Wirkung im Feld",
    meta:"Mehrfachauswahl (2 richtig)",
    prompt:"Welche Aussagen beschreiben korrekt die Wirkung eines Dielektrikums im Kondensator? (2 Antworten sind richtig.)",
    options:[
      {k:"A", t:"Es polarisiert sich im elektrischen Feld.", ok:true},
      {k:"B", t:"Es verringert die resultierende Feldstärke im Kondensator.", ok:true},
      {k:"C", t:"Es verstärkt das elektrische Feld zwischen den Platten.", ok:false},
      {k:"D", t:"Es macht die Spannung bei isoliertem Kondensator größer, weil die Ladung zunimmt.", ok:false},
      {k:"E", t:"Es sorgt dafür, dass \\(\\varepsilon_0\\) größer wird.", ok:false}
    ],
    solutionHtml: `
      <p>Im Dielektrikum werden Moleküle/Bindungen polarisiert. Dadurch entstehen gebundene Oberflächenladungen, die ein <b>Gegenfeld</b> erzeugen.</p>
      <p>Das resultierende Feld wird kleiner als ohne Dielektrikum, daher ist bei gleicher Ladung die Spannung kleiner und die Kapazität größer.</p>`
  },

  {
    id:"T3",
    type:"match",
    title:"Permittivitätszahl \\(\\varepsilon_r\\)",
    meta:"Zuordnung (Dropdowns)",
    prompt:"Ordne den Materialien eine typische Permittivitätszahl zu.",
    subitems:[
      {label:"Vakuum", correct:"1"},
      {label:"Luft",   correct:"1,0006"},
      {label:"Glas",   correct:"6–8"},
      {label:"Wasser", correct:"≈80"}
    ],
    choices:["1","1,0006","2,5–3","6–8","≈80"],
    solutionHtml: `
      <p>Typische Werte:</p>
      <ul>
        <li>Vakuum: \\(\\varepsilon_r=1\\) (Definition)</li>
        <li>Luft: knapp über 1 (hier \\(1{,}0006\\))</li>
        <li>Glas: einige Einheiten (hier \\(6\\text{–}8\\))</li>
        <li>Wasser: sehr groß (hier etwa \\(80\\))</li>
      </ul>`
  },

  {
    id:"T4",
    type:"cloze2",
    title:"Kapazität mit Dielektrikum – Formel",
    meta:"Lückentext (Dropdowns)",
    promptParts:[
      "Die Kapazität eines Plattenkondensators mit Dielektrikum berechnet sich zu ",
      "C = ",
      {blankId:"b1"},
      " · ",
      {blankId:"b2"},
      " · A / d"
    ],
    blanks:{
      b1:{ choices:["ε₀","U","Q","E","R"], correct:"ε₀" },
      b2:{ choices:["εᵣ","I","P","d","A"], correct:"εᵣ" }
    },
    solutionHtml: `
      <p>Mit Dielektrikum gilt:</p>
      <p>\\(C=\\varepsilon_0\\,\\varepsilon_r\\,\\frac{A}{d}\\)</p>
      <p>\\(\\varepsilon_0\\) ist die elektrische Feldkonstante, \\(\\varepsilon_r\\) die materialabhängige Permittivitätszahl.</p>`
  },

  {
    id:"T5",
    type:"radio",
    title:"Isolierter Kondensator – was bleibt konstant?",
    meta:"Einfachauswahl (1 richtig)",
    prompt:"Ein geladener Kondensator wird von der Spannungsquelle getrennt. Anschließend wird ein Dielektrikum eingeführt. Welche Größe bleibt konstant?",
    options:[
      {k:"A", t:"Spannung \\(U\\)", ok:false},
      {k:"B", t:"Kapazität \\(C\\)", ok:false},
      {k:"C", t:"Elektrische Feldstärke \\(E\\)", ok:false},
      {k:"D", t:"Ladung \\(Q\\)", ok:true},
      {k:"E", t:"Permittivitätszahl \\(\\varepsilon_r\\)", ok:false}
    ],
    solutionHtml: `
      <p>Nach dem Trennen von der Quelle kann keine Ladung nachfließen oder abfließen ⇒ \\(Q\\) bleibt konstant.</p>
      <p>Durch das Dielektrikum steigt \\(C\\). Da \\(C=\\frac{Q}{U}\\), folgt bei konstantem \\(Q\\): \\(U\\) wird kleiner.</p>`
  },

  {
    id:"T6",
    type:"radio",
    title:"Energie – Abhängigkeit von der Spannung",
    meta:"Einfachauswahl (1 richtig)",
    prompt:"Die Spannung eines Kondensators wird verdoppelt (Kapazität konstant). Wie verändert sich die gespeicherte Energie?",
    options:[
      {k:"A", t:"Sie halbiert sich.", ok:false},
      {k:"B", t:"Sie bleibt gleich.", ok:false},
      {k:"C", t:"Sie verdoppelt sich.", ok:false},
      {k:"D", t:"Sie vervierfacht sich.", ok:true},
      {k:"E", t:"Sie verachtfacht sich.", ok:false}
    ],
    solutionHtml: `
      <p>Mit \\(E=\\tfrac12 C U^2\\) gilt \\(E\\propto U^2\\). Verdoppeln von \\(U\\) ⇒ \\(E\\) wird viermal so groß.</p>`
  },

  {
    id:"T7",
    type:"match",
    title:"Batterie vs. Kondensator – Zuordnung",
    meta:"Zuordnung (Dropdowns)",
    prompt:"Ordne jede Aussage dem passenden System zu.",
    subitems:[
      {label:"Spannung bleibt während der Entladung (idealisiert) konstant.", correct:"Batterie"},
      {label:"Spannung steigt proportional mit der Ladung \\(Q\\).", correct:"Kondensator"},
      {label:"Im \\(U(Q)\\)-Diagramm entspricht die abgegebene Energie einer Rechteckfläche.", correct:"Batterie"},
      {label:"Im \\(U(Q)\\)-Diagramm entspricht die gespeicherte Energie näherungsweise einer Dreiecksfläche.", correct:"Kondensator"}
    ],
    choices:["Batterie","Kondensator","Beide","Keines","Kommt darauf an"],
    solutionHtml: `
      <p><b>Batterie:</b> \\(U\\) (idealisiert) konstant ⇒ Energie \\(\\Delta E=U_B\\,\\Delta Q\\) ⇒ Rechteckfläche.</p>
      <p><b>Kondensator:</b> \\(U=\\frac{Q}{C}\\) linear in \\(Q\\) ⇒ Energie entspricht einer Dreiecksfläche ⇒ \\(E=\\tfrac12 Q\\,U\\).</p>`
  },

  {
    id:"T8",
    type:"radio",
    title:"Rechnen – gespeicherte Energie",
    meta:"Rechenaufgabe als MC (1 richtig)",
    prompt:"Ein Kondensator hat \\(C=1\\,\\mathrm{F}\\) und wird auf \\(U=2{,}5\\,\\mathrm{V}\\) geladen. Wie groß ist die gespeicherte Energie?",
    options:[
      {k:"A", t:"\\(3{,}1\\,\\mathrm{J}\\)", ok:true},
      {k:"B", t:"\\(1{,}25\\,\\mathrm{J}\\)", ok:false},
      {k:"C", t:"\\(6{,}25\\,\\mathrm{J}\\)", ok:false},
      {k:"D", t:"\\(12{,}5\\,\\mathrm{J}\\)", ok:false},
      {k:"E", t:"\\(0{,}31\\,\\mathrm{J}\\)", ok:false}
    ],
    solutionHtml: `
      <p>\\(E=\\tfrac12 C U^2\\)</p>
      <p>\\(E=\\tfrac12\\cdot 1\\cdot (2{,}5)^2=0{,}5\\cdot 6{,}25=3{,}125\\,\\mathrm{J}\\approx 3{,}1\\,\\mathrm{J}\\)</p>`
  },

  {
    id:"T9",
    type:"radio",
    title:"Quelle angeschlossen – Dielektrikum einschieben",
    meta:"Einfachauswahl (1 richtig)",
    prompt:"Ein Kondensator ist an eine Spannungsquelle angeschlossen. Zwischen die Platten wird ein Dielektrikum geschoben. Welche Aussage ist korrekt?",
    options:[
      {k:"A", t:"Die Spannung sinkt, die Ladung bleibt konstant.", ok:false},
      {k:"B", t:"Die Spannung bleibt konstant, die Ladung nimmt zu.", ok:true},
      {k:"C", t:"Spannung und Ladung bleiben konstant.", ok:false},
      {k:"D", t:"Spannung und Ladung nehmen beide ab.", ok:false},
      {k:"E", t:"Die Kapazität sinkt, weil das Feld schwächer wird.", ok:false}
    ],
    solutionHtml: `
      <p>Bei angeschlossener Quelle ist \\(U\\) fest vorgegeben.</p>
      <p>Durch das Dielektrikum steigt \\(C\\). Da \\(Q=C\\,U\\), folgt: \\(Q\\) nimmt zu (Ladung fließt aus der Quelle nach).</p>`
  },

  {
    id:"T10",
    type:"match",
    title:"Isolierter Kondensator wird auseinandergezogen",
    meta:"Zuordnung (Dropdowns)",
    prompt:"Ein geladener <b>isolierter</b> Kondensator wird auseinandergezogen. Wie verändern sich die Größen?",
    subitems:[
      {label:"Ladung \\(Q\\)", correct:"bleibt konstant"},
      {label:"Spannung \\(U\\)", correct:"nimmt zu"},
      {label:"Feldstärke \\(E\\)", correct:"nimmt ab"},
      {label:"Kapazität \\(C\\)", correct:"nimmt ab"}
    ],
    choices:["nimmt zu","bleibt konstant","nimmt ab","wird null","nicht bestimmbar"],
    solutionHtml: `
      <ul>
        <li>Isoliert ⇒ \\(Q\\) konstant.</li>
        <li>\\(C=\\varepsilon_0\\varepsilon_r\\frac{A}{d}\\): größeres \\(d\\) ⇒ \\(C\\) nimmt ab.</li>
        <li>\\(U=\\frac{Q}{C}\\): wenn \\(C\\) kleiner wird, steigt \\(U\\).</li>
        <li>Im Schulmodell: größerer Plattenabstand ⇒ kleinere mittlere Feldstärke zwischen den Platten.</li>
      </ul>`
  },

  {
    id:"T11",
    type:"radio",
    title:"Energie beim Auseinanderziehen",
    meta:"Einfachauswahl (1 richtig)",
    prompt:"Ein geladener, isolierter Kondensator wird auseinandergezogen. Wie verändert sich die gespeicherte Energie (und warum)?",
    options:[
      {k:"A", t:"Sie bleibt konstant, weil \\(Q\\) konstant bleibt.", ok:false},
      {k:"B", t:"Sie nimmt ab, da Ladung verloren geht.", ok:false},
      {k:"C", t:"Sie nimmt zu, weil mechanische Arbeit gegen das elektrische Feld verrichtet wird.", ok:true},
      {k:"D", t:"Sie wird vollständig in Wärme umgewandelt.", ok:false},
      {k:"E", t:"Sie nimmt zu, weil \\(\\varepsilon_0\\) größer wird.", ok:false}
    ],
    solutionHtml: `
      <p>Beim Auseinanderziehen müssen die Platten gegen die Anziehungskraft getrennt werden.</p>
      <p>Diese mechanische Arbeit wird als zusätzliche elektrische Energie im Feld gespeichert (Energiezunahme).</p>`
  },

  {
    id:"T12",
    type:"radio",
    title:"Rechnen – Kapazität mit Dielektrikum",
    meta:"Rechenaufgabe als MC (1 richtig)",
    prompt:"Ein Plattenkondensator besitzt \\(A=0{,}020\\,\\mathrm{m^2}\\), \\(d=1{,}0\\,\\mathrm{mm}\\) und ein Dielektrikum mit \\(\\varepsilon_r=6\\) (Glas). Wie groß ist \\(C\\)?",
    options:[
      {k:"A", t:"\\(1{,}1\\cdot 10^{-9}\\,\\mathrm{F}\\)", ok:true},
      {k:"B", t:"\\(5{,}3\\cdot 10^{-10}\\,\\mathrm{F}\\)", ok:false},
      {k:"C", t:"\\(1{,}1\\cdot 10^{-10}\\,\\mathrm{F}\\)", ok:false},
      {k:"D", t:"\\(6{,}0\\cdot 10^{-9}\\,\\mathrm{F}\\)", ok:false},
      {k:"E", t:"\\(1{,}1\\cdot 10^{-6}\\,\\mathrm{F}\\)", ok:false}
    ],
    solutionHtml: `
      <p>\\(C=\\varepsilon_0\\,\\varepsilon_r\\,\\frac{A}{d}\\), \\(\\varepsilon_0=8{,}85\\cdot 10^{-12}\\,\\mathrm{F/m}\\), \\(d=1{,}0\\,\\mathrm{mm}=1{,}0\\cdot 10^{-3}\\,\\mathrm{m}\\)</p>
      <p>
        \\[
          C=8{,}85\\cdot 10^{-12}\\cdot 6\\cdot\\frac{0{,}020}{1{,}0\\cdot 10^{-3}}
          =8{,}85\\cdot 10^{-12}\\cdot 6\\cdot 20
          \\approx 1{,}06\\cdot 10^{-9}\\,\\mathrm{F}
          \\approx 1{,}1\\cdot 10^{-9}\\,\\mathrm{F}
        \\]
      </p>`
  }
];

/* =========================
   RENDER
========================= */
document.getElementById("courseUi").textContent = COURSE_NAME;
document.getElementById("sheetUi").textContent  = SHEET_ID;

(function setDate(){
  const d = new Date();
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yyyy = d.getFullYear();
  document.getElementById("today").textContent = `${dd}.${mm}.${yyyy}`;
})();

const nameInput = document.getElementById("studentName");
nameInput.value = state.name || "";
nameInput.addEventListener("input", ()=>{
  state.name = nameInput.value.trim();
  saveState();
});

function taskBgClass(i){
  const n = (i % 12) + 1;
  return "bg"+n;
}

function htmlEscape(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}

function getTaskState(id){
  return {
    ans: state.answers[id],
    attempted: !!state.attempted[id],
    firstCorrect: !!state.firstCorrect[id],
    wrongStreak: clampInt(state.wrongStreak[id] ?? 0, 0, 999),
    unlocked: !!state.solutionUnlocked[id]
  };
}

function setAttempted(id, firstCorrectBool){
  state.attempted[id] = true;
  state.firstCorrect[id] = !!firstCorrectBool;
  if(firstCorrectBool){
    state.wrongStreak[id] = 0;
  }
  saveState();
}

function bumpWrongStreak(id){
  const w = clampInt(state.wrongStreak[id] ?? 0, 0, 999) + 1;
  state.wrongStreak[id] = w;
  if(w >= 3) state.solutionUnlocked[id] = true;
  saveState();
}

function unlockSolution(id){
  state.solutionUnlocked[id] = true;
  saveState();
}

function computeScore(){
  const ids = tasksData.map(t=>t.id);
  const attemptedCount = ids.filter(id => !!state.attempted[id]).length;
  const firstCorrectIds = ids.filter(id => state.attempted[id] && state.firstCorrect[id]);
  const firstWrongIds   = ids.filter(id => state.attempted[id] && !state.firstCorrect[id]);
  const score = `${firstCorrectIds.length}/${ids.length}`;
  return { score, attemptedCount, firstCorrectIds, firstWrongIds, total: ids.length };
}

function updateScoreUi(){
  const s = computeScore();
  document.getElementById("scoreUi").textContent = s.score;
}

function normalizeOptionOrder(task){
  if(task.type !== "radio" && task.type !== "checkbox") return task;
  const seed = (state.seed ^ hashStr(task.id)) >>> 0;
  const shuffled = seededShuffle(task.options, seed);
  return Object.assign({}, task, { options: shuffled });
}

function normalizeChoicesOrder(task){
  if(task.type === "match"){
    const seed = (state.seed ^ hashStr(task.id + "__choices")) >>> 0;
    return Object.assign({}, task, { choices: seededShuffle(task.choices, seed) });
  }
  if(task.type === "cloze2"){
    const b = JSON.parse(JSON.stringify(task.blanks));
    for(const key of Object.keys(b)){
      const seed = (state.seed ^ hashStr(task.id + "__" + key)) >>> 0;
      b[key].choices = seededShuffle(b[key].choices, seed);
    }
    return Object.assign({}, task, { blanks: b });
  }
  return task;
}

function hashStr(s){
  let h = 2166136261;
  for(let i=0;i<s.length;i++){
    h ^= s.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h >>> 0;
}

function renderTasks(){
  const host = document.getElementById("tasks");
  host.innerHTML = "";

  tasksData.forEach((rawTask, idx)=>{
    let task = normalizeOptionOrder(rawTask);
    task = normalizeChoicesOrder(task);

    const tState = getTaskState(task.id);
    const attemptedNote = tState.attempted
      ? (tState.firstCorrect ? "Erstversuch: richtig ✅" : "Erstversuch: falsch ❌")
      : "Noch nicht gewertet";

    const wrap = document.createElement("div");
    wrap.className = `task ${taskBgClass(idx)}`;
    wrap.dataset.taskId = task.id;

    wrap.innerHTML = `
      <div class="taskHead">
        <div>
          <h3 class="taskTitle">${idx+1}. ${htmlEscape(task.title)}</h3>
          <div class="taskMeta">${htmlEscape(task.meta)} · <span id="note_${task.id}">${attemptedNote}</span> · Fehlversuche: <span id="ws_${task.id}">${tState.wrongStreak}</span></div>
        </div>
        <div style="display:flex; gap:10px; align-items:flex-start; flex-wrap:wrap;">
          <button class="btn checkBtn" data-action="check" data-id="${task.id}">Prüfen</button>
          <button class="btn btnWarn solBtn" data-action="showSol" data-id="${task.id}" style="${tState.unlocked ? "" : "display:none"}">Lösungsweg anzeigen</button>
        </div>
      </div>
      <div class="taskBody">
        <p class="qtext">${renderPrompt(task)}</p>
        ${renderInput(task, tState)}
        <div class="feedback" id="fb_${task.id}" style="display:none"></div>
        <div class="sol" id="sol_${task.id}">
          <h4>Lösungsweg</h4>
          <div class="solBody">${task.solutionHtml}</div>
        </div>
      </div>
    `;

    host.appendChild(wrap);
    applySavedAnswers(task);
  });

  if(window.MathJax && MathJax.typesetPromise){
    MathJax.typesetPromise();
  }

  updateScoreUi();
}

function renderPrompt(task){
  if(task.type === "cloze2"){
    return task.promptParts.map(p=>{
      if(typeof p === "string") return htmlEscape(p);
      if(p && p.blankId){
        return `<span class="pill" style="padding:6px 10px; font-size:13px;">Lücke ${htmlEscape(p.blankId)}</span>`;
      }
      return "";
    }).join("");
  }
  return htmlEscape(task.prompt || "");
}

function renderInput(task, tState){
  const aid = `ans_${task.id}`;
  if(task.type === "radio" || task.type === "checkbox"){
    const inputType = task.type;
    const chosen = tState.ans ?? (inputType === "checkbox" ? [] : "");
    const optsHtml = task.options.map((o, i)=>{
      const id = `${aid}_${i}`;
      const checked = (inputType === "radio")
        ? (chosen === o.k)
        : (Array.isArray(chosen) && chosen.includes(o.k));
      return `
        <div class="opt">
          <input ${inputType==="radio" ? `name="${aid}"` : ""} id="${id}" type="${inputType}" value="${htmlEscape(o.k)}" ${checked ? "checked":""} />
          <label for="${id}"><b>${htmlEscape(o.k)}</b> ${o.t}</label>
        </div>
      `;
    }).join("");
    return `<div class="options" data-input="${task.type}" data-id="${task.id}">${optsHtml}</div>`;
  }

  if(task.type === "match"){
    const choicesHtml = (choices, selected)=> {
      const opts = [`<option value="">— auswählen —</option>`].concat(
        choices.map(c => `<option value="${htmlEscape(c)}" ${selected===c ? "selected":""}>${htmlEscape(c)}</option>`)
      ).join("");
      return opts;
    };

    const saved = (tState.ans && typeof tState.ans === "object") ? tState.ans : {};
    const rows = task.subitems.map((si, idx)=>{
      const sel = saved[idx] ?? "";
      return `
        <div class="subrow">
          <div>${htmlEscape(si.label)}</div>
          <div>
            <select data-match="${task.id}" data-idx="${idx}">
              ${choicesHtml(task.choices, sel)}
            </select>
          </div>
        </div>
      `;
    }).join("");
    return `<div class="subgrid" style="display:block">${rows}</div>`;
  }

  if(task.type === "cloze2"){
    const saved = (tState.ans && typeof tState.ans === "object") ? tState.ans : {};
    const parts = task.promptParts.map(p=>{
      if(typeof p === "string") return `<span>${htmlEscape(p)}</span>`;
      if(p && p.blankId){
        const b = task.blanks[p.blankId];
        const selected = saved[p.blankId] ?? "";
        const opts = [`<option value="">— auswählen —</option>`].concat(
          b.choices.map(c => `<option value="${htmlEscape(c)}" ${selected===c ? "selected":""}>${htmlEscape(c)}</option>`)
        ).join("");
        return `<select data-cloze="${task.id}" data-blank="${htmlEscape(p.blankId)}" style="display:inline-block; width:auto; min-width:120px; vertical-align:middle;">${opts}</select>`;
      }
      return "";
    }).join("");
    return `<div class="qtext" style="margin-top:8px">${parts}</div>`;
  }

  return "";
}

function applySavedAnswers(task){
  const container = document.querySelector(`.options[data-id="${task.id}"]`);
  if(container && (task.type === "radio" || task.type === "checkbox")){
    container.addEventListener("change", ()=>{
      if(task.type === "radio"){
        const checked = container.querySelector(`input[type="radio"]:checked`);
        state.answers[task.id] = checked ? checked.value : "";
      } else {
        const checks = [...container.querySelectorAll(`input[type="checkbox"]:checked`)].map(x=>x.value);
        state.answers[task.id] = checks;
      }
      saveState();
    }, {passive:true});
  }

  if(task.type === "match"){
    const selects = document.querySelectorAll(`select[data-match="${task.id}"]`);
    selects.forEach(sel=>{
      sel.addEventListener("change", ()=>{
        const idx = Number(sel.dataset.idx);
        const obj = (state.answers[task.id] && typeof state.answers[task.id]==="object") ? state.answers[task.id] : {};
        obj[idx] = sel.value;
        state.answers[task.id] = obj;
        saveState();
      }, {passive:true});
    });
  }

  if(task.type === "cloze2"){
    const selects = document.querySelectorAll(`select[data-cloze="${task.id}"]`);
    selects.forEach(sel=>{
      sel.addEventListener("change", ()=>{
        const blank = sel.dataset.blank;
        const obj = (state.answers[task.id] && typeof state.answers[task.id]==="object") ? state.answers[task.id] : {};
        obj[blank] = sel.value;
        state.answers[task.id] = obj;
        saveState();
      }, {passive:true});
    });
  }
}

/* =========================
   EVALUATION
========================= */
function evalTask(task){
  const ans = state.answers[task.id];

  if(task.type === "radio"){
    const chosen = (typeof ans === "string") ? ans : "";
    const correct = task.options.find(o=>o.ok)?.k;
    const isCorrect = chosen && chosen === correct;
    return { isCorrect, details: isCorrect ? "Richtig." : "Nicht korrekt.", missing: chosen ? "" : "Keine Auswahl getroffen." };
  }

  if(task.type === "checkbox"){
    const chosen = Array.isArray(ans) ? ans.slice() : [];
    const correctSet = new Set(task.options.filter(o=>o.ok).map(o=>o.k));
    const chosenSet  = new Set(chosen);

    let rightChosen = 0, wrongChosen = 0, rightMissing = 0;
    for(const k of chosenSet){
      if(correctSet.has(k)) rightChosen++; else wrongChosen++;
    }
    for(const k of correctSet){
      if(!chosenSet.has(k)) rightMissing++;
    }

    const isCorrect = (wrongChosen === 0 && rightMissing === 0 && chosen.length > 0);

    let details = "";
    if(chosen.length === 0){
      details = "Keine Auswahl getroffen.";
    } else if(chosen.length === 1){
      const only = chosen[0];
      details = correctSet.has(only) ? "Diese Auswahl ist korrekt." : "Diese Auswahl ist nicht korrekt.";
      if(!correctSet.has(only) && correctSet.size > 1){
        details += ` (Es gibt insgesamt ${correctSet.size} richtige Antworten.)`;
      }
    } else {
      details = `${rightChosen} richtig gewählt, ${wrongChosen} falsch gewählt, ${rightMissing} richtige fehlen.`;
    }

    return { isCorrect, details };
  }

  if(task.type === "match"){
    const obj = (ans && typeof ans === "object") ? ans : {};
    let okCount = 0;
    let filled = 0;
    task.subitems.forEach((si, idx)=>{
      const v = obj[idx] ?? "";
      if(v) filled++;
      if(v === si.correct) okCount++;
    });

    const allFilled = (filled === task.subitems.length);
    const isCorrect = allFilled && okCount === task.subitems.length;

    let details = "";
    if(!allFilled){
      details = `Bitte alle Zuordnungen auswählen. (${filled}/${task.subitems.length} ausgefüllt)`;
    } else if(isCorrect){
      details = "Alle Zuordnungen sind korrekt.";
    } else {
      details = `${okCount}/${task.subitems.length} Zuordnungen korrekt.`;
    }
    return { isCorrect, details };
  }

  if(task.type === "cloze2"){
    const obj = (ans && typeof ans === "object") ? ans : {};
    const keys = Object.keys(task.blanks);
    let filled = 0, ok = 0;
    keys.forEach(k=>{
      const v = obj[k] ?? "";
      if(v) filled++;
      if(v && v === task.blanks[k].correct) ok++;
    });
    const isCorrect = (filled === keys.length) && (ok === keys.length);

    let details = "";
    if(filled < keys.length){
      details = `Bitte alle Lücken füllen. (${filled}/${keys.length})`;
    } else if(isCorrect){
      details = "Lückentext korrekt.";
    } else {
      details = `${ok}/${keys.length} Lücken korrekt.`;
    }
    return { isCorrect, details };
  }

  return { isCorrect:false, details:"Unbekannter Aufgabentyp." };
}

function showFeedback(taskId, kind, mainText, extraText){
  const fb = document.getElementById("fb_"+taskId);
  if(!fb) return;
  fb.style.display = "block";
  fb.className = "feedback " + (kind==="ok" ? "fbOk" : kind==="warn" ? "fbWarn" : "fbBad");
  fb.innerHTML = `
    <div><b>${mainText}</b></div>
    ${extraText ? `<div class="fbSmall">${extraText}</div>` : ""}
  `;
}

function updateTaskMeta(taskId){
  const tState = getTaskState(taskId);
  const note = document.getElementById("note_"+taskId);
  const ws   = document.getElementById("ws_"+taskId);
  if(note){
    note.textContent = tState.attempted ? (tState.firstCorrect ? "Erstversuch: richtig ✅" : "Erstversuch: falsch ❌") : "Noch nicht gewertet";
  }
  if(ws) ws.textContent = tState.wrongStreak;

  const solBtn = document.querySelector(`button.solBtn[data-id="${taskId}"]`);
  if(solBtn) solBtn.style.display = tState.unlocked ? "" : "none";
}

/* =========================
   EVENTS: CHECK + SOLUTION
========================= */
document.addEventListener("click", (e)=>{
  const btn = e.target.closest("button");
  if(!btn) return;

  const action = btn.dataset.action;
  const id = btn.dataset.id;

  if(action === "check"){
    const task = normalizeChoicesOrder(normalizeOptionOrder(tasksData.find(t=>t.id===id)));
    if(!task) return;

    const result = evalTask(task);

    const tState = getTaskState(id);
    if(!tState.attempted){
      setAttempted(id, result.isCorrect);
    }

    if(result.isCorrect){
      state.wrongStreak[id] = 0;
      saveState();
      showFeedback(id, "ok", "✅ Richtig", result.details || "");
    } else {
      bumpWrongStreak(id);
      const w = clampInt(state.wrongStreak[id] ?? 0, 0, 999);
      const extra = (result.details || "") + (w>=3 ? " (Lösungsweg ist freigeschaltet.)" : "");
      showFeedback(id, "bad", "❌ Nicht korrekt", extra);
    }

    updateTaskMeta(id);
    updateScoreUi();

    if(window.MathJax && MathJax.typesetPromise){
      MathJax.typesetPromise([document.getElementById("fb_"+id)]);
    }
  }

  if(action === "showSol"){
    const sol = document.getElementById("sol_"+id);
    if(!sol) return;
    unlockSolution(id);
    sol.style.display = (sol.style.display === "block") ? "none" : "block";
    updateTaskMeta(id);
    if(window.MathJax && MathJax.typesetPromise){
      MathJax.typesetPromise([sol]);
    }
  }
});

/* =========================
   SEND TO HBL (Google Apps Script)
   FIX: wie im alten AB -> mode:"no-cors" + kein res.ok/json check
========================= */
async function sendToHBL(){
  const name = (state.name || "").trim();
  if(!name){
    const st = document.getElementById("sendStatus");
    st.textContent = "Name fehlt";
    st.className = "statusBad";
    nameInput.focus();
    return;
  }

  const s = computeScore();
  const sentAtISO = nowIso();
  const workTimeSec = Math.max(0, Math.round((Date.parse(sentAtISO) - Date.parse(state.startedAt)) / 1000));

  const payload = {
    name: name,
    classCode: COURSE_NAME,
    sheetId: SHEET_ID,
    score: s.score,
    attemptedCount: s.attemptedCount,
    firstCorrectTasks: s.firstCorrectIds.join(","),
    firstWrongTasks: s.firstWrongIds.join(","),
    startedAt: state.startedAt,
    sentAt: sentAtISO,
    workTimeSec: workTimeSec,
    ua: navigator.userAgent
    // page/location.href: bewusst NICHT senden
  };

  const statusEl = document.getElementById("sendStatus");
  const sendBtn  = document.getElementById("sendBtn");

  statusEl.textContent = "Sende...";
  statusEl.className = "statusWait";
  sendBtn.disabled = true;

  try{
    await fetch(WEBAPP_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    state.send.lastStatus = "OK";
    state.send.lastAt = sentAtISO;
    saveState();

    statusEl.textContent = "OK";
    statusEl.className = "statusOk";
  }catch(err){
    state.send.lastStatus = "Fehler";
    state.send.lastAt = sentAtISO;
    saveState();

    statusEl.textContent = "Fehler";
    statusEl.className = "statusBad";
  }finally{
    setTimeout(()=>{ sendBtn.disabled = false; }, 700);
  }
}

document.getElementById("sendBtn").addEventListener("click", sendToHBL);

/* =========================
   INIT
========================= */
renderTasks();
updateScoreUi();

// restore last send status UI
(function(){
  const st = state.send?.lastStatus || "—";
  const el = document.getElementById("sendStatus");
  if(st === "OK"){
    el.textContent = "OK";
    el.className = "statusOk";
  } else if(st === "Fehler"){
    el.textContent = "Fehler";
    el.className = "statusBad";
  } else {
    el.textContent = "—";
    el.className = "statusWait";
  }
})();
</script>
</body>
</html>
